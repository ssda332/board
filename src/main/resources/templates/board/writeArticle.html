<!DOCTYPE html>
<html th:replace="~{fragments/layout :: layout(~{::title},~{::section})}" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>board</title>
</head>

<body>
    <section class="container-fluid">
        <h3>글 작성</h3>
        <hr>

        <div class="mb-3">
            <label for="selectCtg" class="form-label">카테고리</label>
            <select id="selectCtg" class="form-control">

            </select>
        </div>

        <!-- TOAST UI Editor가 들어갈 div태그 -->
        <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input class="form-control" id="title">
        </div>

        <div id="editor"></div>
        <button id="write" onclick="writeArticle()" type="button" class="btn btn-primary" style="margin-top: 10px">작성</button>

        <!-- TOAST UI EDITOR JS-->
        <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
        <script src="/js/common.js"></script>
        <script src="/js/common_hierachy.js"></script>
        <script src="/vendor/jquery/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jwt-decode-module@1.0.4/build/jwt-decode.min.js">

        </script>
        <script>
            const editor = new toastui.Editor({
                el: document.querySelector('#editor'),
                previewStyle: 'vertical',
                height: '500px',
                initialValue: '내용을 적어주세요.',
                hooks: {
                    addImageBlobHook(blob, callback) {  // 이미지 업로드 로직 커스텀
                        console.log(blob);
                        console.log(callback);
                    }
                }

            });

            function writeArticle() {
                const articleDto = {atcNum: '',
                                    atcTitle: document.querySelector("#title").value,
                                    atcContent: editor.getHTML(),
                                    atcWriter: decodeToken("refreshToken").memId,
                                    ctgId: document.querySelector("#selectCtg").value
                };

                console.log(articleDto);


                // 권한 검색
                tokenToJson("POST", "/article/new", JSON.stringify(articleDto), true,
                    function(data, status, xhr) {
                        console.log("게시글 작성 성공");
                        location.href="/article?category=" + document.querySelector("#selectCtg").value;
                    },

                    function(xhr, status, error) {
                        console.log("게시글 작성 실패");
                    }
                );
            }

            // 작성 가능한 카테고리 조회
            ajaxJson("GET", "/category/list", {type: 2}, false,
                function(data, status, xhr) {
                    const categoryList = data; // 받아온 JSON 데이터
                    const selectCtg = document.querySelector("#selectCtg");
                    const html = category_canWrite(categoryList);

                    document.getElementById('selectCtg').innerHTML += html;

                    // category 쿼리스트링 값을 가져오기 (예시: "?category=3")
                    const urlParams = new URLSearchParams(window.location.search);
                    const categoryParam = urlParams.get('category');

                    // category 쿼리스트링 값이 있다면 해당 값의 Option을 선택
                    if (categoryParam) {
                        const selectedOption = selectCtg.querySelector(`option[value="${categoryParam}"]`);
                        if (selectedOption) {
                            selectedOption.selected = true;
                        }
                    }


                },

                function(xhr, status, error) {
                    alert("카테고리 조회 실패!");
                }
            );


        </script>
    </section>
</body>
</html>
